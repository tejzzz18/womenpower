{# templates/chatbot.html #}
{% extends "base.html" %}

{% block title %}Chatbot — Mahila Suraksha Nyayavani{% endblock %}

{% block head_extra %}
<style>
.chatbox { max-width:720px; margin:20px auto; }
.messages { min-height:200px; border:1px solid #ddd; padding:12px; border-radius:8px; background:#fff; }
.msg { margin:8px 0; padding:8px 10px; border-radius:6px; }
.msg.user { background:#e6f2ff; text-align:right; }
.msg.bot { background:#f3f3f3; text-align:left; }
input[type="text"] { width:80%; padding:10px; }
button { padding:10px 14px; }
</style>
{% endblock %}

{% block content %}
<div class="chatbox container">
  <h2>Chat with Support</h2>
  <div id="messages" class="messages"></div>

  <form id="chatForm">
    <input id="userInput" type="text" placeholder="Ask for help or type your question..." autocomplete="off" />
    <button type="submit">Send</button>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
const API_URL = "http://localhost:3000/api/chat";

function appendMessage(text, cls="bot") {
  const div = document.createElement("div");
  div.className = "msg " + (cls === "user" ? "user" : "bot");
  div.innerText = text;
  document.getElementById("messages").appendChild(div);
  document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
}

document.getElementById("chatForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const input = document.getElementById("userInput");
  const text = input.value.trim();
  if (!text) return;
  appendMessage(text, "user");
  input.value = "";
  appendMessage("…Thinking…", "bot");

  try {
    const resp = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userText: text })
    });

    const data = await resp.json();
    const msgs = document.querySelectorAll("#messages .msg.bot");
    if (msgs.length) msgs[msgs.length - 1].remove();

    if (resp.ok && data.reply) {
      appendMessage(data.reply, "bot");
    } else {
      appendMessage("Sorry, something went wrong. Try again later.", "bot");
      console.error("Error from proxy:", data);
    }
  } catch (err) {
    const msgs = document.querySelectorAll("#messages .msg.bot");
    if (msgs.length) msgs[msgs.length - 1].remove();
    appendMessage("Network error. Is the proxy running?", "bot");
    console.error(err);
  }
});
</script>
{% endblock %}
